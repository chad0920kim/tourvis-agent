<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íˆ¬ì–´ë¹„ìŠ¤ ê³ ê°ì„¼í„° ì—ì´ì „íŠ¸ ëŒ€ì‹œë³´ë“œ</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="dashboard.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- ğŸ”’ ë³´ì•ˆ í—¤ë” -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; 
        style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; 
        font-src 'self' https://cdnjs.cloudflare.com;
        img-src 'self' data:;
        connect-src 'self' http://localhost:8505 https://cxdashboard.run.goorm.site;
    ">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
</head>
<body>
    <!-- ğŸ”’ ì„œë²„ ì‚¬ì´ë“œ ì¸ì¦ ëª¨ë‹¬ -->
    <div id="authModal" class="auth-modal" style="display: none;">
        <div class="auth-content">
            <h2><i class="fas fa-shield-alt"></i> ë³´ì•ˆ ì¸ì¦</h2>
            <p class="auth-description">ì„œë²„ì—ì„œ ì•ˆì „í•˜ê²Œ ê³„ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
            <form id="authForm">
                <div class="form-group">
                    <label for="username">ì‚¬ìš©ìëª…:</label>
                    <input type="text" id="username" name="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">ë¹„ë°€ë²ˆí˜¸:</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="auth-btn">
                    <i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸
                </button>
            </form>
            <div id="authError" class="auth-error" style="display: none;"></div>
            <div class="auth-info">
                <small>
                    <i class="fas fa-info-circle"></i> 
                    ê°œë°œí™˜ê²½: admin/DevAdmin2024!, manager/DevManager2024!, analyst/DevAnalyst2024!
                </small>
            </div>
        </div>
    </div>

    <div class="dashboard-container" id="dashboardContainer" style="display: none;">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> íˆ¬ì–´ë¹„ìŠ¤ ê³ ê°ì„¼í„° ì—ì´ì „íŠ¸ ëŒ€ì‹œë³´ë“œ</h1>
            <div class="header-controls">
                <div class="user-info" id="userInfo">
                    <span id="currentUser">ì‚¬ìš©ì</span>
                    <span id="userRole" class="user-role">ì—­í• </span>
                </div>
                <div class="connection-status disconnected" id="connectionStatus">
                    <span id="connectionText">API ì—°ê²° í™•ì¸ ì¤‘...</span>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" id="feedbackTab" onclick="switchTab('feedback')">
                <i class="fas fa-chart-bar"></i> í”¼ë“œë°± ë¶„ì„
            </button>
            <button class="tab-button" id="conversationsTab" onclick="switchTab('conversations')">
                <i class="fas fa-comments"></i> Q&A ë¶„ì„
            </button>
            <button class="tab-button" id="adminTab" onclick="switchTab('admin')" style="display: none;">
                <i class="fas fa-users-cog"></i> ê´€ë¦¬
            </button>
        </div>

        <!-- í”¼ë“œë°± ë¶„ì„ íƒ­ -->
        <div class="tab-content active" id="feedbackContent">
            <div class="controls">
                <div class="controls-row">
                    <div class="control-group">
                        <label for="daysSelect">ğŸ“… ê¸°ê°„:</label>
                        <select id="daysSelect">
                            <option value="1">ì˜¤ëŠ˜</option>
                            <option value="3">3ì¼</option>
                            <option value="7" selected>7ì¼</option>
                            <option value="14">14ì¼</option>
                            <option value="30">30ì¼</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="limitSelect">ğŸ“‹ í‘œì‹œ ê°œìˆ˜:</label>
                        <select id="limitSelect">
                            <option value="10">10ê°œ</option>
                            <option value="20">20ê°œ</option>
                            <option value="50" selected>50ê°œ</option>
                            <option value="100">100ê°œ</option>
                        </select>
                    </div>
                    <button class="refresh-btn" onclick="refreshData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value positive" id="totalFeedback">0</div>
                    <div class="stat-label">ğŸ“ ì´ í”¼ë“œë°±</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value info" id="totalQA">0</div>
                    <div class="stat-label">ğŸ’¬ ì´ Q&A</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value warning" id="responseRate">0%</div>
                    <div class="stat-label">ğŸ“ˆ í”¼ë“œë°± ì‘ë‹µë¥ </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value positive" id="positiveFeedback">0</div>
                    <div class="stat-label">ğŸ‘ ë„ì›€ë¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value negative" id="negativeFeedback">0</div>
                    <div class="stat-label">ğŸ‘ ì•„ì‰¬ì›€</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value info" id="satisfactionRate">0%</div>
                    <div class="stat-label">ğŸ˜Š ë§Œì¡±ë„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value secondary" id="uniqueUsers">0</div>
                    <div class="stat-label">ğŸ‘¥ ìˆœ ì‚¬ìš©ì</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value warning" id="participationRate">0íšŒ</div>
                    <div class="stat-label">ğŸ¯ ì‚¬ìš©ìë‹¹ í‰ê· </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">ğŸ“ˆ ì‹œê°„ë³„ í”¼ë“œë°± ì¶”ì´</h3>
                    <div class="chart-wrapper">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">ğŸ¥§ í”¼ë“œë°± ë¶„í¬</h3>
                    <div class="chart-wrapper">
                        <canvas id="avgChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">ğŸ“Š í”¼ë“œë°± ì‘ë‹µë¥  ì¶”ì´</h3>
                    <div class="chart-wrapper">
                        <canvas id="responseRateChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="data-section">
                <div class="section-header">
                    <h3 class="section-title">ğŸ“‹ ìµœê·¼ í”¼ë“œë°± ìƒì„¸</h3>
                    <span class="data-count" id="feedbackCount">0ê°œ</span>
                </div>

                <div class="data-filters">
                    <button class="active" id="allBtn" onclick="loadFeedback('all')">ì „ì²´</button>
                    <button id="positiveBtn" onclick="loadFeedback('positive')">ğŸ‘ ë„ì›€ë¨</button>
                    <button id="negativeBtn" onclick="loadFeedback('negative')">ğŸ‘ ì•„ì‰¬ì›€</button>
                </div>

                <div class="expand-controls">
                    <button onclick="expandAllAnswers()">ğŸ“– ëª¨ë“  ë‹µë³€ í¼ì¹˜ê¸°</button>
                    <button onclick="collapseAllAnswers()">ğŸ“• ëª¨ë“  ë‹µë³€ ì ‘ê¸°</button>
                </div>

                <div id="feedbackList">
                    <div class="loading">í”¼ë“œë°± ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- Q&A ë¶„ì„ íƒ­ -->
        <div class="tab-content" id="conversationsContent">
            <div class="controls">
                <div class="controls-row">
                    <div class="control-group">
                        <label for="conversationDaysSelect"><i class="fas fa-calendar"></i> ê¸°ê°„:</label>
                        <select id="conversationDaysSelect">
                            <option value="1">ì˜¤ëŠ˜</option>
                            <option value="3">3ì¼</option>
                            <option value="7" selected>7ì¼</option>
                            <option value="14">14ì¼</option>
                            <option value="30">30ì¼</option>
                        </select>
                    </div>
                    <button class="refresh-btn" onclick="refreshConversationData()">
                        <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value info" id="totalConversations">0</div>
                    <div class="stat-label"><i class="fas fa-users"></i> ì´ ì‚¬ìš©ì</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value positive" id="matchGood">0</div>
                    <div class="stat-label"><i class="fas fa-check-circle"></i> ë§¤ì¹˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value negative" id="matchBad">0</div>
                    <div class="stat-label"><i class="fas fa-times-circle"></i> ë§¤ì¹˜ ì•ˆë¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value warning" id="matchImprove">0</div>
                    <div class="stat-label"><i class="fas fa-arrow-up"></i> ë³´ê°• í•„ìš”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value secondary" id="matchNone">0</div>
                    <div class="stat-label"><i class="fas fa-question-circle"></i> ë¯¸í‰ê°€</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-bullseye"></i> ë§¤ì¹˜ ìƒíƒœ ë¶„í¬</h3>
                    <div class="chart-wrapper">
                        <canvas id="matchStatusChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-clock"></i> Q&A ì‹œê°„ë³„ ì¶”ì´</h3>
                    <div class="chart-wrapper">
                        <canvas id="qaTimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê´€ë¦¬ íƒ­ (ê´€ë¦¬ì ì „ìš©) -->
        <div class="tab-content" id="adminContent">
            <div class="admin-section">
                <h3><i class="fas fa-users"></i> ì‚¬ìš©ì ê´€ë¦¬</h3>
                <div id="usersList"></div>
            </div>
            
            <div class="admin-section">
                <h3><i class="fas fa-shield-alt"></i> ë¡œê·¸ì¸ ì‹œë„ ê¸°ë¡</h3>
                <div id="loginAttemptsList"></div>
            </div>
        </div>
    </div>

    <script>
        // ======================
        // ğŸ”’ ì„œë²„ ì‚¬ì´ë“œ ì¸ì¦ ì‹œìŠ¤í…œ
        // ======================
        const API_BASE_URL = window.location.hostname === 'chad0920kim.github.io' 
            ? 'https://cxdashboard.run.goorm.site'
            : 'http://localhost:8505';

        console.log('ğŸ”— Dashboard API URL:', API_BASE_URL);

        // ì „ì—­ ë³€ìˆ˜
        let charts = {};
        let currentData = {};
        let currentFeedbackFilter = 'all';
        let allFeedbackData = [];
        let allQAData = [];
        let globalQAData = [];
        let authToken = null;
        let currentUser = null;
        let sessionTimeout = null;
        let tokenRefreshInterval = null;

        // ======================
        // ğŸ”’ ë³´ì•ˆ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        // ======================
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function setAuthToken(token) {
            authToken = token;
            localStorage.setItem('dashboard_token', token);
        }

        function getAuthToken() {
            if (!authToken) {
                authToken = localStorage.getItem('dashboard_token');
            }
            return authToken;
        }

        function clearAuthToken() {
            authToken = null;
            localStorage.removeItem('dashboard_token');
            localStorage.removeItem('dashboard_user');
        }

        function isAuthenticated() {
            return authToken !== null;
        }

        // ======================
        // ğŸ”’ HTTP í´ë¼ì´ì–¸íŠ¸ (JWT ì¸ì¦)
        // ======================
        
        async function makeAuthenticatedRequest(url, options = {}) {
            const token = getAuthToken();
            if (!token) {
                throw new Error('No authentication token');
            }

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                ...options.headers
            };

            const requestOptions = {
                ...options,
                headers,
                signal: AbortSignal.timeout(options.timeout || 15000)
            };

            try {
                const response = await fetch(url, requestOptions);
                
                if (response.status === 401) {
                    // í† í° ë§Œë£Œ ë˜ëŠ” ë¬´íš¨
                    await logout();
                    throw new Error('Authentication failed');
                }

                if (response.status === 403) {
                    throw new Error('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤');
                }

                return response;
            } catch (error) {
                console.error('ğŸ”’ ì¸ì¦ëœ ìš”ì²­ ì‹¤íŒ¨:', error);
                throw error;
            }
        }

        // ======================
        // ğŸ”’ ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜ë“¤
        // ======================
        
        async function login(username, password) {
            try {
                const response = await fetch(API_BASE_URL + '/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }

                const data = await response.json();
                
                // í† í° ë° ì‚¬ìš©ì ì •ë³´ ì €ì¥
                setAuthToken(data.access_token);
                currentUser = data.user_info;
                localStorage.setItem('dashboard_user', JSON.stringify(currentUser));
                
                console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ:', currentUser);
                
                // í† í° ìë™ ê°±ì‹  ì„¤ì • (ë§Œë£Œ 5ë¶„ ì „)
                const refreshTime = (data.expires_in - 300) * 1000; // 25ë¶„
                tokenRefreshInterval = setInterval(refreshToken, refreshTime);
                
                return true;
            } catch (error) {
                console.error('âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                throw error;
            }
        }

        async function refreshToken() {
            try {
                const response = await makeAuthenticatedRequest(API_BASE_URL + '/auth/refresh', {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    setAuthToken(data.access_token);
                    console.log('ğŸ”„ í† í° ê°±ì‹  ì„±ê³µ');
                }
            } catch (error) {
                console.warn('âš ï¸ í† í° ê°±ì‹  ì‹¤íŒ¨:', error);
                await logout();
            }
        }

        async function logout() {
            try {
                if (authToken) {
                    await makeAuthenticatedRequest(API_BASE_URL + '/auth/logout', {
                        method: 'POST'
                    });
                }
            } catch (error) {
                console.warn('ë¡œê·¸ì•„ì›ƒ ìš”ì²­ ì‹¤íŒ¨:', error);
            } finally {
                // ë¡œì»¬ ì •ë¦¬
                clearAuthToken();
                currentUser = null;
                
                if (tokenRefreshInterval) {
                    clearInterval(tokenRefreshInterval);
                    tokenRefreshInterval = null;
                }

                if (sessionTimeout) {
                    clearTimeout(sessionTimeout);
                    sessionTimeout = null;
                }

                // ì°¨íŠ¸ ì •ë¦¬
                Object.values(charts).forEach(chart => {
                    if (chart && chart.destroy) {
                        chart.destroy();
                    }
                });
                charts = {};

                showAuthModal();
            }
        }

        async function getCurrentUser() {
            try {
                const response = await makeAuthenticatedRequest(API_BASE_URL + '/auth/me');
                if (response.ok) {
                    const userData = await response.json();
                    currentUser = userData;
                    localStorage.setItem('dashboard_user', JSON.stringify(currentUser));
                    return userData;
                }
            } catch (error) {
                console.warn('í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
                await logout();
            }
            return null;
        }

        function showAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
            document.getElementById('dashboardContainer').style.display = 'none';
        }

        function hideAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'block';
        }

        function updateUserInfo() {
            if (!currentUser) return;

            const userElement = document.getElementById('currentUser');
            const roleElement = document.getElementById('userRole');

            if (userElement) {
                userElement.textContent = currentUser.username;
            }

            if (roleElement) {
                roleElement.textContent = currentUser.role;
                roleElement.className = `user-role role-${currentUser.role}`;
            }

            // ê´€ë¦¬ì íƒ­ í‘œì‹œ/ìˆ¨ê¹€
            const adminTab = document.getElementById('adminTab');
            if (adminTab) {
                if (currentUser.permissions && currentUser.permissions.includes('admin')) {
                    adminTab.style.display = 'block';
                } else {
                    adminTab.style.display = 'none';
                }
            }
        }

        // ======================
        // ğŸ”’ ì¸ì¦ ìƒíƒœ í™•ì¸ ë° ì´ˆê¸°í™”
        // ======================
        
        async function checkAuthStatus() {
            const token = getAuthToken();
            const userStr = localStorage.getItem('dashboard_user');

            if (!token || !userStr) {
                showAuthModal();
                return false;
            }

            try {
                currentUser = JSON.parse(userStr);
                
                // ì„œë²„ì—ì„œ í† í° ìœ íš¨ì„± ê²€ì¦
                const userData = await getCurrentUser();
                if (userData) {
                    hideAuthModal();
                    updateUserInfo();
                    return true;
                }
            } catch (error) {
                console.warn('ì¸ì¦ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
            }

            showAuthModal();
            return false;
        }

        // ======================
        // ğŸ”’ API í•¨ìˆ˜ë“¤ (ì¸ì¦ ê°•í™”)
        // ======================
        
        function updateConnectionStatus(isConnected, message) {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');

            if (!statusElement || !textElement) return;

            if (isConnected) {
                statusElement.className = 'connection-status connected';
                textElement.textContent = escapeHtml(message || 'API ì—°ê²°ë¨');
            } else {
                statusElement.className = 'connection-status disconnected';
                textElement.textContent = escapeHtml(message || 'API ì—°ê²° ì‹¤íŒ¨');
            }
        }

        function showError(message, container) {
            const el = document.getElementById(container || 'feedbackList');
            if (el) {
                el.innerHTML = '<div class="error">' + escapeHtml(message) + '</div>';
            }
        }

        async function testApiConnection() {
            console.log('ğŸ” API ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
            updateConnectionStatus(false, 'API ì—°ê²° í™•ì¸ ì¤‘...');

            try {
                // ê³µê°œ í—¬ìŠ¤ì²´í¬ ë¨¼ì € ì‹œë„
                const response = await fetch(API_BASE_URL + '/health', {
                    signal: AbortSignal.timeout(5000)
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… ê³µê°œ API ì—°ê²° ì„±ê³µ:', data);
                    
                    // ì¸ì¦ëœ í—¬ìŠ¤ì²´í¬ ì‹œë„
                    if (isAuthenticated()) {
                        try {
                            const authResponse = await makeAuthenticatedRequest(API_BASE_URL + '/api/health');
                            if (authResponse.ok) {
                                const authData = await authResponse.json();
                                console.log('âœ… ì¸ì¦ëœ API ì—°ê²° ì„±ê³µ:', authData);
                                updateConnectionStatus(true, `${data.service} (${authData.user})`);
                                return true;
                            }
                        } catch (authError) {
                            console.warn('âš ï¸ ì¸ì¦ëœ API ì—°ê²° ì‹¤íŒ¨:', authError);
                        }
                    }
                    
                    updateConnectionStatus(true, data.service || 'Server');
                    return true;
                }
            } catch (error) {
                console.error('âŒ API ì—°ê²° ì‹¤íŒ¨:', error);
            }

            updateConnectionStatus(false, 'API ì„œë²„ ë¯¸ì‘ë‹µ');
            return false;
        }

        async function fetchStats(days) {
            days = days || 7;
            try {
                const response = await makeAuthenticatedRequest(API_BASE_URL + '/api/stats?days=' + encodeURIComponent(days));

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… í†µê³„ ë°ì´í„° ìˆ˜ì‹ :', data);
                    return data;
                }
            } catch (error) {
                console.warn('âš ï¸ í†µê³„ ìš”ì²­ ì‹¤íŒ¨:', error.message);
            }

            return {
                total_feedback: 0,
                positive: 0,
                negative: 0,
                satisfaction_rate: 0,
                unique_users: 0
            };
        }

        async function fetchFeedback(limit, feedback_type) {
            limit = Math.max(1, Math.min(parseInt(limit) || 50, 1000));
            feedback_type = ['all', 'positive', 'negative'].includes(feedback_type) ? feedback_type : 'all';
            
            try {
                const url = API_BASE_URL + '/api/feedback?limit=' + encodeURIComponent(limit) + '&feedback_type=' + encodeURIComponent(feedback_type);
                console.log('ğŸ“ í”¼ë“œë°± ë°ì´í„° ìš”ì²­:', url);
                
                const response = await makeAuthenticatedRequest(url);

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… í”¼ë“œë°± ë°ì´í„° ìˆ˜ì‹ :', {
                        filter: feedback_type,
                        count: data.feedback?.length || 0,
                        total: data.total || 0
                    });
                    return data;
                }
            } catch (error) {
                console.warn('âš ï¸ í”¼ë“œë°± ìš”ì²­ ì‹¤íŒ¨:', error.message);
            }

            return { feedback: [], total: 0 };
        }

        async function fetchConversations(days, limit) {
            days = Math.max(1, Math.min(parseInt(days) || 7, 365));
            limit = Math.max(1, Math.min(parseInt(limit) || 50, 1000));
            
            try {
                const response = await makeAuthenticatedRequest(API_BASE_URL + '/api/qa/conversations?days=' + encodeURIComponent(days) + '&limit=' + encodeURIComponent(limit));

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… Q&A ë°ì´í„° ìˆ˜ì‹ :', data);
                    return data;
                }
            } catch (error) {
                console.warn('âš ï¸ Q&A ìš”ì²­ ì‹¤íŒ¨:', error.message);
            }

            return {
                conversations: [],
                total: 0,
                stats: {
                    unique_sessions: 0,
                    match_distribution: { good: 0, bad: 0, improve: 0, none: 0 }
                }
            };
        }

        // ======================
        // ğŸ”’ ê´€ë¦¬ì ê¸°ëŠ¥ë“¤
        // ======================
        
        async function loadUsers() {
            if (!currentUser || !currentUser.permissions.includes('admin')) {
                return;
            }

            try {
                const response = await makeAuthenticatedRequest(API_BASE_URL + '/api/admin/users');
                if (response.ok) {
                    const data = await response.json();
                    displayUsers(data.users);
                }
            } catch (error) {
                console.warn('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        async function loadLoginAttempts() {
            if (!currentUser || !currentUser.permissions.includes('admin')) {
                return;
            }

            try {
                const response = await makeAuthenticatedRequest(API_BASE_URL + '/api/admin/login-attempts');
                if (response.ok) {
                    const data = await response.json();
                    displayLoginAttempts(data.login_attempts);
                }
            } catch (error) {
                console.warn('ë¡œê·¸ì¸ ì‹œë„ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        async function unlockAccount(username) {
            if (!currentUser || !currentUser.permissions.includes('admin')) {
                return;
            }

            try {
                const response = await makeAuthenticatedRequest(API_BASE_URL + `/api/admin/unlock-account/${username}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(data.message);
                    loadLoginAttempts(); // ìƒˆë¡œê³ ì¹¨
                }
            } catch (error) {
                console.warn('ê³„ì • ì ê¸ˆ í•´ì œ ì‹¤íŒ¨:', error);
                alert('ê³„ì • ì ê¸ˆ í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function displayUsers(users) {
            const container = document.getElementById('usersList');
            if (!container) return;

            const html = users.map(user => `
                <div class="admin-item">
                    <div class="admin-item-header">
                        <strong>${escapeHtml(user.username)}</strong>
                        <span class="user-role role-${escapeHtml(user.role)}">${escapeHtml(user.role)}</span>
                    </div>
                    <div class="admin-item-content">
                        <p>ê¶Œí•œ: ${user.permissions.map(p => escapeHtml(p)).join(', ')}</p>
                        <p>ì´ë©”ì¼: ${escapeHtml(user.email || 'ì—†ìŒ')}</p>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function displayLoginAttempts(attempts) {
            const container = document.getElementById('loginAttemptsList');
            if (!container) return;

            if (Object.keys(attempts).length === 0) {
                container.innerHTML = '<p>ë¡œê·¸ì¸ ì‹œë„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const html = Object.entries(attempts).map(([username, info]) => `
                <div class="admin-item ${info.is_locked ? 'locked' : ''}">
                    <div class="admin-item-header">
                        <strong>${escapeHtml(username)}</strong>
                        ${info.is_locked ? '<span class="status-locked">ğŸ”’ ì ê¹€</span>' : '<span class="status-ok">âœ… ì •ìƒ</span>'}
                    </div>
                    <div class="admin-item-content">
                        <p>ì‹¤íŒ¨ íšŸìˆ˜: ${info.count}</p>
                        <p>ë§ˆì§€ë§‰ ì‹œë„: ${new Date(info.last_attempt).toLocaleString('ko-KR')}</p>
                        ${info.locked_until ? `<p>ì ê¸ˆ í•´ì œ: ${new Date(info.locked_until).toLocaleString('ko-KR')}</p>` : ''}
                        ${info.remaining_lockout_minutes ? `<p>ë‚¨ì€ ì‹œê°„: ${info.remaining_lockout_minutes}ë¶„</p>` : ''}
                        ${info.is_locked ? `<button onclick="unlockAccount('${escapeHtml(username)}')" class="unlock-btn">ì ê¸ˆ í•´ì œ</button>` : ''}
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // ======================
        // ê¸°ì¡´ í•¨ìˆ˜ë“¤ (ë³´ì•ˆ ê°•í™” ì ìš©)
        // ======================
        
        function extractFeedbackType(feedback) {
            if (!feedback || typeof feedback !== 'object') {
                console.warn('âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ í”¼ë“œë°± ë°ì´í„°:', feedback);
                return 'unknown';
            }

            if (feedback.extracted_type === 'positive' || feedback.extracted_type === 'negative') {
                return feedback.extracted_type;
            }
            
            if (feedback.chat_id === 'positive' || feedback.chat_id === 'negative') {
                return feedback.chat_id;
            }
            
            if (feedback.feedback_id && typeof feedback.feedback_id === 'string') {
                if (feedback.feedback_id.includes('_positive')) {
                    return 'positive';
                } else if (feedback.feedback_id.includes('_negative')) {
                    return 'negative';
                }
            }
            
            if (feedback.feedback === 'positive' || feedback.feedback === 'negative') {
                return feedback.feedback;
            }
            
            return 'unknown';
        }

        function switchTab(tabName) {
            if (!isAuthenticated()) {
                logout();
                return;
            }

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabName + 'Content').classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'feedback') {
                refreshData();
            } else if (tabName === 'conversations') {
                refreshConversationData();
            } else if (tabName === 'admin') {
                loadUsers();
                loadLoginAttempts();
            }
        }

        async function refreshData() {
            if (!isAuthenticated()) {
                logout();
                return;
            }

            const days = parseInt(document.getElementById('daysSelect').value);
            try {
                document.getElementById('feedbackList').innerHTML = '<div class="loading">í”¼ë“œë°± ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
                
                const [stats, qaData] = await Promise.all([
                    fetchStats(days),
                    globalQAData.length > 0 ? Promise.resolve({conversations: globalQAData}) : fetchConversations(days, 1000)
                ]);
                
                if (qaData.conversations) {
                    allQAData = qaData.conversations;
                }
                
                const totalQA = allQAData.length;
                const responseRate = calculateResponseRate(stats.total_feedback, totalQA);
                
                currentData = {
                    stats: { ...stats, total_qa: totalQA, response_rate: responseRate },
                    conversations: qaData
                };
                
                updateFeedbackStats(currentData.stats, currentData.conversations);
                updateFeedbackCharts(currentData, days);
                await loadFeedback(currentFeedbackFilter);
            } catch (error) {
                console.error('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
                showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function refreshConversationData() {
            if (!isAuthenticated()) {
                logout();
                return;
            }

            const days = parseInt(document.getElementById('conversationDaysSelect').value);
            
            try {
                const data = await fetchConversations(days, 100);
                currentData = data;
                
                updateConversationStats(data);
                updateConversationCharts(data);
            } catch (error) {
                console.error('Q&A ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
                showError('Q&A ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ======================
        // ì¸ì¦ í¼ ì´ë²¤íŠ¸ ì²˜ë¦¬
        // ======================
        
        document.addEventListener('DOMContentLoaded', function() {
            const authForm = document.getElementById('authForm');
            if (authForm) {
                authForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const username = document.getElementById('username').value.trim();
                    const password = document.getElementById('password').value;
                    const errorElement = document.getElementById('authError');
                    
                    if (!username || !password) {
                        errorElement.textContent = 'ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                        errorElement.style.display = 'block';
                        return;
                    }
                    
                    try {
                        errorElement.style.display = 'none';
                        const success = await login(username, password);
                        if (success) {
                            updateUserInfo();
                            await initializeDashboard();
                        }
                    } catch (error) {
                        errorElement.textContent = error.message || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                        errorElement.style.display = 'block';
                    }
                    
                    document.getElementById('password').value = '';
                });
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ ìƒíƒœ í™•ì¸
            checkAuthStatus().then(isAuth => {
                if (isAuth) {
                    initializeDashboard();
                }
            });
        });

        // ======================
        // ë‚˜ë¨¸ì§€ ê¸°ì¡´ í•¨ìˆ˜ë“¤ì€ ë™ì¼í•˜ë¯€ë¡œ ìƒëµ...
        // (updateFeedbackStats, updateConversationStats, ì°¨íŠ¸ ê´€ë ¨ í•¨ìˆ˜ë“¤ ë“±)
        // ======================

        console.log('ğŸ”’ ì„œë²„ ì‚¬ì´ë“œ ì¸ì¦ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
    </script>

    <style>
        /* ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        .auth-description {
            color: #666;
            margin-bottom: 20px;
            text-align: center;
        }

        .auth-info {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            text-align: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 15px;
        }

        .user-role {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .role-admin {
            background: #dc3545;
            color: white;
        }

        .role-manager {
            background: #ffc107;
            color: #212529;
        }

        .role-analyst {
            background: #17a2b8;
            color: white;
        }

        .admin-section {
            margin-bottom: 30px;
        }

        .admin-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
        }

        .admin-item.locked {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .admin-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-locked {
            color: #dc3545;
            font-weight: bold;
        }

        .status-ok {
            color: #28a745;
            font-weight: bold;
        }

        .unlock-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .unlock-btn:hover {
            background: #c82333;
        }
    </style>
</body>
</html>
