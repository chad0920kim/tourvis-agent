<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>투어비스 고객센터 에이전트 대시보드</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="dashboard.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- 🔒 보안 헤더 -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; 
        style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; 
        font-src 'self' https://cdnjs.cloudflare.com;
        img-src 'self' data:;
        connect-src 'self' http://localhost:8505 https://cxdashboard.run.goorm.site;
    ">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
</head>
<body>
    <!-- 🔒 서버 사이드 인증 모달 -->
    <div id="authModal" class="auth-modal" style="display: none;">
        <div class="auth-content">
            <h2><i class="fas fa-shield-alt"></i> 보안 인증</h2>
            <p class="auth-description">서버에서 안전하게 계정을 관리합니다</p>
            <form id="authForm">
                <div class="form-group">
                    <label for="username">사용자명:</label>
                    <input type="text" id="username" name="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">비밀번호:</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="auth-btn">
                    <i class="fas fa-sign-in-alt"></i> 로그인
                </button>
            </form>
            <div id="authError" class="auth-error" style="display: none;"></div>
            <div class="auth-info">
                <small>
                    <i class="fas fa-info-circle"></i> 
                    개발환경: admin/DevAdmin2024!, manager/DevManager2024!, analyst/DevAnalyst2024!
                </small>
            </div>
        </div>
    </div>

    <div class="dashboard-container" id="dashboardContainer" style="display: none;">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> 투어비스 고객센터 에이전트 대시보드</h1>
            <div class="header-controls">
                <div class="user-info" id="userInfo">
                    <span id="currentUser">사용자</span>
                    <span id="userRole" class="user-role">역할</span>
                </div>
                <div class="connection-status disconnected" id="connectionStatus">
                    <span id="connectionText">API 연결 확인 중...</span>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> 로그아웃
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" id="feedbackTab" onclick="switchTab('feedback')">
                <i class="fas fa-chart-bar"></i> 피드백 분석
            </button>
            <button class="tab-button" id="conversationsTab" onclick="switchTab('conversations')">
                <i class="fas fa-comments"></i> Q&A 분석
            </button>
            <button class="tab-button" id="adminTab" onclick="switchTab('admin')" style="display: none;">
                <i class="fas fa-users-cog"></i> 관리
            </button>
        </div>

        <!-- 피드백 분석 탭 -->
        <div class="tab-content active" id="feedbackContent">
            <div class="controls">
                <div class="controls-row">
                    <div class="control-group">
                        <label for="daysSelect">📅 기간:</label>
                        <select id="daysSelect">
                            <option value="1">오늘</option>
                            <option value="3">3일</option>
                            <option value="7" selected>7일</option>
                            <option value="14">14일</option>
                            <option value="30">30일</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="limitSelect">📋 표시 개수:</label>
                        <select id="limitSelect">
                            <option value="10">10개</option>
                            <option value="20">20개</option>
                            <option value="50" selected>50개</option>
                            <option value="100">100개</option>
                        </select>
                    </div>
                    <button class="refresh-btn" onclick="refreshData()">🔄 새로고침</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value positive" id="totalFeedback">0</div>
                    <div class="stat-label">📝 총 피드백</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value info" id="totalQA">0</div>
                    <div class="stat-label">💬 총 Q&A</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value warning" id="responseRate">0%</div>
                    <div class="stat-label">📈 피드백 응답률</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value positive" id="positiveFeedback">0</div>
                    <div class="stat-label">👍 도움됨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value negative" id="negativeFeedback">0</div>
                    <div class="stat-label">👎 아쉬움</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value info" id="satisfactionRate">0%</div>
                    <div class="stat-label">😊 만족도</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value secondary" id="uniqueUsers">0</div>
                    <div class="stat-label">👥 순 사용자</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value warning" id="participationRate">0회</div>
                    <div class="stat-label">🎯 사용자당 평균</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">📈 시간별 피드백 추이</h3>
                    <div class="chart-wrapper">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">🥧 피드백 분포</h3>
                    <div class="chart-wrapper">
                        <canvas id="avgChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">📊 피드백 응답률 추이</h3>
                    <div class="chart-wrapper">
                        <canvas id="responseRateChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="data-section">
                <div class="section-header">
                    <h3 class="section-title">📋 최근 피드백 상세</h3>
                    <span class="data-count" id="feedbackCount">0개</span>
                </div>

                <div class="data-filters">
                    <button class="active" id="allBtn" onclick="loadFeedback('all')">전체</button>
                    <button id="positiveBtn" onclick="loadFeedback('positive')">👍 도움됨</button>
                    <button id="negativeBtn" onclick="loadFeedback('negative')">👎 아쉬움</button>
                </div>

                <div class="expand-controls">
                    <button onclick="expandAllAnswers()">📖 모든 답변 펼치기</button>
                    <button onclick="collapseAllAnswers()">📕 모든 답변 접기</button>
                </div>

                <div id="feedbackList">
                    <div class="loading">피드백 데이터를 불러오는 중...</div>
                </div>
            </div>
        </div>

        <!-- Q&A 분석 탭 -->
        <div class="tab-content" id="conversationsContent">
            <div class="controls">
                <div class="controls-row">
                    <div class="control-group">
                        <label for="conversationDaysSelect"><i class="fas fa-calendar"></i> 기간:</label>
                        <select id="conversationDaysSelect">
                            <option value="1">오늘</option>
                            <option value="3">3일</option>
                            <option value="7" selected>7일</option>
                            <option value="14">14일</option>
                            <option value="30">30일</option>
                        </select>
                    </div>
                    <button class="refresh-btn" onclick="refreshConversationData()">
                        <i class="fas fa-sync-alt"></i> 새로고침
                    </button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value info" id="totalConversations">0</div>
                    <div class="stat-label"><i class="fas fa-users"></i> 총 사용자</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value positive" id="matchGood">0</div>
                    <div class="stat-label"><i class="fas fa-check-circle"></i> 매치</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value negative" id="matchBad">0</div>
                    <div class="stat-label"><i class="fas fa-times-circle"></i> 매치 안됨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value warning" id="matchImprove">0</div>
                    <div class="stat-label"><i class="fas fa-arrow-up"></i> 보강 필요</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value secondary" id="matchNone">0</div>
                    <div class="stat-label"><i class="fas fa-question-circle"></i> 미평가</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-bullseye"></i> 매치 상태 분포</h3>
                    <div class="chart-wrapper">
                        <canvas id="matchStatusChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-clock"></i> Q&A 시간별 추이</h3>
                    <div class="chart-wrapper">
                        <canvas id="qaTimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 관리 탭 (관리자 전용) -->
        <div class="tab-content" id="adminContent">
            <div class="admin-section">
                <h3><i class="fas fa-users"></i> 사용자 관리</h3>
                <div id="usersList"></div>
            </div>
            
            <div class="admin-section">
                <h3><i class="fas fa-shield-alt"></i> 로그인 시도 기록</h3>
                <div id="loginAttemptsList"></div>
            </div>
        </div>
    </div>

    <script>
        // ======================
        // 🔒 서버 사이드 인증 시스템
        // ======================
        const API_BASE_URL = window.location.hostname === 'chad0920kim.github.io' 
            ? 'https://cxdashboard.run.goorm.site'
            : 'http://localhost:8505';

        console.log('🔗 Dashboard API URL:', API_BASE_URL);

        // 전역 변수
        let charts = {};
        let currentData = {};
        let currentFeedbackFilter = 'all';
        let allFeedbackData = [];
        let allQAData = [];
        let globalQAData = [];
        let authToken = null;
        let currentUser = null;
        let sessionTimeout = null;
        let tokenRefreshInterval = null;

        // ======================
        // 🔒 보안 유틸리티 함수들
        // ======================
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function setAuthToken(token) {
            authToken = token;
            localStorage.setItem('dashboard_token', token);
        }

        function getAuthToken() {
            if (!authToken) {
                authToken = localStorage.getItem('dashboard_token');
            }
            return authToken;
        }

        function clearAuthToken() {
            authToken = null;
            localStorage.removeItem('dashboard_token');
            localStorage.removeItem('dashboard_user');
        }

        function isAuthenticated() {
            return authToken !== null;
        }

        // ======================
        // 🔒 HTTP 클라이언트 (JWT 인증)
        // ======================
        
        async function makeAuthenticatedRequest(url, options = {}) {
            const token = getAuthToken();
            if (!token) {
                throw new Error('No authentication token');
            }

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                ...options.headers
            };

            const requestOptions = {
                ...options,
                headers,
                signal: AbortSignal.timeout(options.timeout || 15000)
            };

            try {
                const response = await fetch(url, requestOptions);
                
                if (response.status === 401) {
                    // 토큰 만료 또는 무효
                    await logout();
                    throw new Error('Authentication failed');
                }

                if (response.status === 403) {
                    throw new Error('권한이 없습니다');
                }

                return response;
            } catch (error) {
                console.error('🔒 인증된 요청 실패:', error);
                throw error;
            }
        }

        // ======================
        // 🔒 인증 관련 함수들
        // ======================
        
        async function login(username, password) {
            try {
                const response = await fetch(API_BASE_URL + '/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '로그인에 실패했습니다');
                }

                const data = await response.json();
                
                // 토큰 및 사용자 정보 저장
                setAuthToken(data.access_token);
                currentUser = data.user_info;
                localStorage.setItem('dashboard_user', JSON.stringify(currentUser));
                
                console.log('✅ 로그인 성공:', currentUser);
                
                // 토큰 자동 갱신 설정 (만료 5분 전)
                const refreshTime = (data.expires_in - 300) * 1000; // 25분
                tokenRefreshInterval = setInterval(refreshToken, refreshTime);
                
                return true;
            } catch (error) {
                console.error('❌ 로그인 실패:', error);
                throw error;
            }
        }

        async function refreshToken() {
            try {
                const response = await makeAuthenticatedRequest(API_BASE_URL + '/auth/refresh', {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    setAuthToken(data.access_token);
                    console.log('🔄 토큰 갱신 성공');
                }
            } catch (error) {
                console.warn('⚠️ 토큰 갱신 실패:', error);
                await logout();
            }
        }

        async function logout() {
            try {
                if (authToken) {
                    await makeAuthenticatedRequest(API_BASE_URL + '/auth/logout', {
                        method: 'POST'
                    });
                }
            } catch (error) {
                console.warn('로그아웃 요청 실패:', error);
            } finally {
                // 로컬 정리
                clearAuthToken();
                currentUser = null;
                
                if (tokenRefreshInterval) {
                    clearInterval(tokenRefreshInterval);
                    tokenRefreshInterval = null;
                }

                if (sessionTimeout) {
                    clearTimeout(sessionTimeout);
                    sessionTimeout = null;
                }

                // 차트 정리
                Object.values(charts).forEach(chart => {
                    if (chart && chart.destroy) {
                        chart.destroy();
                    }
                });
                charts = {};

                showAuthModal();
            }
        }

        async function getCurrentUser() {
            try {
                const response = await makeAuthenticatedRequest(API_BASE_URL + '/auth/me');
                if (response.ok) {
                    const userData = await response.json();
                    currentUser = userData;
                    localStorage.setItem('dashboard_user', JSON.stringify(currentUser));
                    return userData;
                }
            } catch (error) {
                console.warn('현재 사용자 정보 조회 실패:', error);
                await logout();
            }
            return null;
        }

        function showAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
            document.getElementById('dashboardContainer').style.display = 'none';
        }

        function hideAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'block';
        }

        function updateUserInfo() {
            if (!currentUser) return;

            const userElement = document.getElementById('currentUser');
            const roleElement = document.getElementById('userRole');

            if (userElement) {
                userElement.textContent = currentUser.username;
            }

            if (roleElement) {
                roleElement.textContent = currentUser.role;
                roleElement.className = `user-role role-${currentUser.role}`;
            }

            // 관리자 탭 표시/숨김
            const adminTab = document.getElementById('adminTab');
            if (adminTab) {
                if (currentUser.permissions && currentUser.permissions.includes('admin')) {
                    adminTab.style.display = 'block';
                } else {
                    adminTab.style.display = 'none';
                }
            }
        }

        // ======================
        // 🔒 인증 상태 확인 및 초기화
        // ======================
        
        async function checkAuthStatus() {
            const token = getAuthToken();
            const userStr = localStorage.getItem('dashboard_user');

            if (!token || !userStr) {
                showAuthModal();
                return false;
            }

            try {
                currentUser = JSON.parse(userStr);
                
                // 서버에서 토큰 유효성 검증
                const userData = await getCurrentUser();
                if (userData) {
                    hideAuthModal();
                    updateUserInfo();
                    return true;
                }
            } catch (error) {
                console.warn('인증 상태 확인 실패:', error);
            }

            showAuthModal();
            return false;
        }

        // ======================
        // 🔒 API 함수들 (인증 강화)
        // ======================
        
        function updateConnectionStatus(isConnected, message) {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');

            if (!statusElement || !textElement) return;

            if (isConnected) {
                statusElement.className = 'connection-status connected';
                textElement.textContent = escapeHtml(message || 'API 연결됨');
            } else {
                statusElement.className = 'connection-status disconnected';
                textElement.textContent = escapeHtml(message || 'API 연결 실패');
            }
        }

        function showError(message, container) {
            const el = document.getElementById(container || 'feedbackList');
            if (el) {
                el.innerHTML = '<div class="error">' + escapeHtml(message) + '</div>';
            }
        }

        async function testApiConnection() {
            console.log('🔍 API 연결 테스트 중...');
            updateConnectionStatus(false, 'API 연결 확인 중...');

            try {
                // 공개 헬스체크 먼저 시도
                const response = await fetch(API_BASE_URL + '/health', {
                    signal: AbortSignal.timeout(5000)
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ 공개 API 연결 성공:', data);
                    
                    // 인증된 헬스체크 시도
                    if (isAuthenticated()) {
                        try {
                            const authResponse = await makeAuthenticatedRequest(API_BASE_URL + '/api/health');
                            if (authResponse.ok) {
                                const authData = await authResponse.json();
                                console.log('✅ 인증된 API 연결 성공:', authData);
                                updateConnectionStatus(true, `${data.service} (${authData.user})`);
                                return true;
                            }
                        } catch (authError) {
                            console.warn('⚠️ 인증된 API 연결 실패:', authError);
                        }
                    }
                    
                    updateConnectionStatus(true, data.service || 'Server');
                    return true;
                }
            } catch (error) {
                console.error('❌ API 연결 실패:', error);
            }

            updateConnectionStatus(false, 'API 서버 미응답');
            return false;
        }

        async function fetchStats(days) {
            days = days || 7;
            try {
                const response = await makeAuthenticatedRequest(API_BASE_URL + '/api/stats?days=' + encodeURIComponent(days));

                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ 통계 데이터 수신:', data);
                    return data;
                }
            } catch (error) {
                console.warn('⚠️ 통계 요청 실패:', error.message);
            }

            return {
                total_feedback: 0,
                positive: 0,
                negative: 0,
                satisfaction_rate: 0,
                unique_users: 0
            };
        }

        async function fetchFeedback(limit, feedback_type) {
            limit = Math.max(1, Math.min(parseInt(limit) || 50, 1000));
            feedback_type = ['all', 'positive', 'negative'].includes(feedback_type) ? feedback_type : 'all';
            
            try {
                const url = API_BASE_URL + '/api/feedback?limit=' + encodeURIComponent(limit) + '&feedback_type=' + encodeURIComponent(feedback_type);
                console.log('📝 피드백 데이터 요청:', url);
                
                const response = await makeAuthenticatedRequest(url);

                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ 피드백 데이터 수신:', {
                        filter: feedback_type,
                        count: data.feedback?.length || 0,
                        total: data.total || 0
                    });
                    return data;
                }
            } catch (error) {
                console.warn('⚠️ 피드백 요청 실패:', error.message);
            }

            return { feedback: [], total: 0 };
        }

        async function fetchConversations(days, limit) {
            days = Math.max(1, Math.min(parseInt(days) || 7, 365));
            limit = Math.max(1, Math.min(parseInt(limit) || 50, 1000));
            
            try {
                const response = await makeAuthenticatedRequest(API_BASE_URL + '/api/qa/conversations?days=' + encodeURIComponent(days) + '&limit=' + encodeURIComponent(limit));

                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Q&A 데이터 수신:', data);
                    return data;
                }
            } catch (error) {
                console.warn('⚠️ Q&A 요청 실패:', error.message);
            }

            return {
                conversations: [],
                total: 0,
                stats: {
                    unique_sessions: 0,
                    match_distribution: { good: 0, bad: 0, improve: 0, none: 0 }
                }
            };
        }

        // ======================
        // 🔒 관리자 기능들
        // ======================
        
        async function loadUsers() {
            if (!currentUser || !currentUser.permissions.includes('admin')) {
                return;
            }

            try {
                const response = await makeAuthenticatedRequest(API_BASE_URL + '/api/admin/users');
                if (response.ok) {
                    const data = await response.json();
                    displayUsers(data.users);
                }
            } catch (error) {
                console.warn('사용자 목록 로드 실패:', error);
            }
        }

        async function loadLoginAttempts() {
            if (!currentUser || !currentUser.permissions.includes('admin')) {
                return;
            }

            try {
                const response = await makeAuthenticatedRequest(API_BASE_URL + '/api/admin/login-attempts');
                if (response.ok) {
                    const data = await response.json();
                    displayLoginAttempts(data.login_attempts);
                }
            } catch (error) {
                console.warn('로그인 시도 기록 로드 실패:', error);
            }
        }

        async function unlockAccount(username) {
            if (!currentUser || !currentUser.permissions.includes('admin')) {
                return;
            }

            try {
                const response = await makeAuthenticatedRequest(API_BASE_URL + `/api/admin/unlock-account/${username}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(data.message);
                    loadLoginAttempts(); // 새로고침
                }
            } catch (error) {
                console.warn('계정 잠금 해제 실패:', error);
                alert('계정 잠금 해제에 실패했습니다.');
            }
        }

        function displayUsers(users) {
            const container = document.getElementById('usersList');
            if (!container) return;

            const html = users.map(user => `
                <div class="admin-item">
                    <div class="admin-item-header">
                        <strong>${escapeHtml(user.username)}</strong>
                        <span class="user-role role-${escapeHtml(user.role)}">${escapeHtml(user.role)}</span>
                    </div>
                    <div class="admin-item-content">
                        <p>권한: ${user.permissions.map(p => escapeHtml(p)).join(', ')}</p>
                        <p>이메일: ${escapeHtml(user.email || '없음')}</p>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function displayLoginAttempts(attempts) {
            const container = document.getElementById('loginAttemptsList');
            if (!container) return;

            if (Object.keys(attempts).length === 0) {
                container.innerHTML = '<p>로그인 시도 기록이 없습니다.</p>';
                return;
            }

            const html = Object.entries(attempts).map(([username, info]) => `
                <div class="admin-item ${info.is_locked ? 'locked' : ''}">
                    <div class="admin-item-header">
                        <strong>${escapeHtml(username)}</strong>
                        ${info.is_locked ? '<span class="status-locked">🔒 잠김</span>' : '<span class="status-ok">✅ 정상</span>'}
                    </div>
                    <div class="admin-item-content">
                        <p>실패 횟수: ${info.count}</p>
                        <p>마지막 시도: ${new Date(info.last_attempt).toLocaleString('ko-KR')}</p>
                        ${info.locked_until ? `<p>잠금 해제: ${new Date(info.locked_until).toLocaleString('ko-KR')}</p>` : ''}
                        ${info.remaining_lockout_minutes ? `<p>남은 시간: ${info.remaining_lockout_minutes}분</p>` : ''}
                        ${info.is_locked ? `<button onclick="unlockAccount('${escapeHtml(username)}')" class="unlock-btn">잠금 해제</button>` : ''}
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // ======================
        // 기존 함수들 (보안 강화 적용)
        // ======================
        
        function extractFeedbackType(feedback) {
            if (!feedback || typeof feedback !== 'object') {
                console.warn('⚠️ 유효하지 않은 피드백 데이터:', feedback);
                return 'unknown';
            }

            if (feedback.extracted_type === 'positive' || feedback.extracted_type === 'negative') {
                return feedback.extracted_type;
            }
            
            if (feedback.chat_id === 'positive' || feedback.chat_id === 'negative') {
                return feedback.chat_id;
            }
            
            if (feedback.feedback_id && typeof feedback.feedback_id === 'string') {
                if (feedback.feedback_id.includes('_positive')) {
                    return 'positive';
                } else if (feedback.feedback_id.includes('_negative')) {
                    return 'negative';
                }
            }
            
            if (feedback.feedback === 'positive' || feedback.feedback === 'negative') {
                return feedback.feedback;
            }
            
            return 'unknown';
        }

        function switchTab(tabName) {
            if (!isAuthenticated()) {
                logout();
                return;
            }

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabName + 'Content').classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'feedback') {
                refreshData();
            } else if (tabName === 'conversations') {
                refreshConversationData();
            } else if (tabName === 'admin') {
                loadUsers();
                loadLoginAttempts();
            }
        }

        async function refreshData() {
            if (!isAuthenticated()) {
                logout();
                return;
            }

            const days = parseInt(document.getElementById('daysSelect').value);
            try {
                document.getElementById('feedbackList').innerHTML = '<div class="loading">피드백 데이터를 불러오는 중...</div>';
                
                const [stats, qaData] = await Promise.all([
                    fetchStats(days),
                    globalQAData.length > 0 ? Promise.resolve({conversations: globalQAData}) : fetchConversations(days, 1000)
                ]);
                
                if (qaData.conversations) {
                    allQAData = qaData.conversations;
                }
                
                const totalQA = allQAData.length;
                const responseRate = calculateResponseRate(stats.total_feedback, totalQA);
                
                currentData = {
                    stats: { ...stats, total_qa: totalQA, response_rate: responseRate },
                    conversations: qaData
                };
                
                updateFeedbackStats(currentData.stats, currentData.conversations);
                updateFeedbackCharts(currentData, days);
                await loadFeedback(currentFeedbackFilter);
            } catch (error) {
                console.error('데이터 새로고침 실패:', error);
                showError('데이터를 불러오는 중 오류가 발생했습니다.');
            }
        }

        async function refreshConversationData() {
            if (!isAuthenticated()) {
                logout();
                return;
            }

            const days = parseInt(document.getElementById('conversationDaysSelect').value);
            
            try {
                const data = await fetchConversations(days, 100);
                currentData = data;
                
                updateConversationStats(data);
                updateConversationCharts(data);
            } catch (error) {
                console.error('Q&A 데이터 새로고침 실패:', error);
                showError('Q&A 데이터를 불러오는 중 오류가 발생했습니다.');
            }
        }

        // ======================
        // 인증 폼 이벤트 처리
        // ======================
        
        document.addEventListener('DOMContentLoaded', function() {
            const authForm = document.getElementById('authForm');
            if (authForm) {
                authForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const username = document.getElementById('username').value.trim();
                    const password = document.getElementById('password').value;
                    const errorElement = document.getElementById('authError');
                    
                    if (!username || !password) {
                        errorElement.textContent = '사용자명과 비밀번호를 입력해주세요.';
                        errorElement.style.display = 'block';
                        return;
                    }
                    
                    try {
                        errorElement.style.display = 'none';
                        const success = await login(username, password);
                        if (success) {
                            updateUserInfo();
                            await initializeDashboard();
                        }
                    } catch (error) {
                        errorElement.textContent = error.message || '로그인에 실패했습니다.';
                        errorElement.style.display = 'block';
                    }
                    
                    document.getElementById('password').value = '';
                });
            }

            // 페이지 로드 시 인증 상태 확인
            checkAuthStatus().then(isAuth => {
                if (isAuth) {
                    initializeDashboard();
                }
            });
        });

        // ======================
        // 나머지 기존 함수들은 동일하므로 생략...
        // (updateFeedbackStats, updateConversationStats, 차트 관련 함수들 등)
        // ======================

        console.log('🔒 서버 사이드 인증 시스템 초기화 완료');
    </script>

    <style>
        /* 추가 스타일 */
        .auth-description {
            color: #666;
            margin-bottom: 20px;
            text-align: center;
        }

        .auth-info {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            text-align: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 15px;
        }

        .user-role {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .role-admin {
            background: #dc3545;
            color: white;
        }

        .role-manager {
            background: #ffc107;
            color: #212529;
        }

        .role-analyst {
            background: #17a2b8;
            color: white;
        }

        .admin-section {
            margin-bottom: 30px;
        }

        .admin-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
        }

        .admin-item.locked {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .admin-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-locked {
            color: #dc3545;
            font-weight: bold;
        }

        .status-ok {
            color: #28a745;
            font-weight: bold;
        }

        .unlock-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .unlock-btn:hover {
            background: #c82333;
        }
    </style>
</body>
</html>
