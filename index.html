<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>투어비스 에이전트</title>
  <script src="https://unpkg.com/event-source-polyfill@1.0.20/eventsource.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #f9f9f9; padding: 20px; }
    #chat { max-width: 800px; margin: auto; }
    .msg { margin: 10px 0; }
    .user, .bot { padding: 10px 14px; border-radius: 6px; display: inline-block; max-width: 100%; white-space: pre-wrap; }
    .user { background: #d1e9ff; font-weight: bold; }
    .bot { background: #eee; }
    .timestamp { font-size: 0.8em; color: #666; margin-left: 8px; }
    #resp { border: 1px solid #ccc; padding: 15px; border-radius: 6px; background: #fff; max-height: 500px; overflow-y: auto; }
    input[type="text"] { width: 70%; padding: 8px; }
    button { padding: 8px 16px; }
  </style>
</head>
<body>
  <div id="chat">
    <h3>질문:</h3>
    <input id="q" type="text" placeholder="예: 서울 호텔 추천해줘" onkeydown="if(event.key==='Enter') send()" />
    <button id="btn" onclick="send()">전송</button>

    <h3>응답:</h3>
    <div id="resp"></div>
  </div>

  <script>
    const respBox = document.getElementById("resp");
    const btn = document.getElementById("btn");

    function addMsg(role, text, timeStr) {
      const wrap = document.createElement("div");
      wrap.className = "msg";

      const box = document.createElement("div");
      box.className = role === "user" ? "user" : "bot";
      box.textContent = text;

      const time = document.createElement("span");
      time.className = "timestamp";
      time.textContent = timeStr || new Date().toLocaleString();

      wrap.appendChild(box);
      wrap.appendChild(time);
      respBox.appendChild(wrap);
      respBox.scrollTop = respBox.scrollHeight;
    }

    function send() {
      const chat_id = "user1";
      const input = document.getElementById("q");
      const message = input.value.trim();
      if (!message) return;

      addMsg("user", message, new Date().toLocaleString());
      input.value = "";
      input.disabled = true;
      btn.disabled = true;

      const botBox = document.createElement("div");
      botBox.className = "msg";
      const botContent = document.createElement("div");
      botContent.className = "bot";
      botContent.textContent = "⏳ 답변 생성 중...";
      botBox.appendChild(botContent);
      respBox.appendChild(botBox);

      const es = new EventSourcePolyfill("https://tourvis-agent-mibqa.run.goorm.site/chat", {
        headers: { "Content-Type": "application/json" },
        method: "POST",
        body: JSON.stringify({ chat_id, message }),
      });

      let fullText = "";

      es.onmessage = e => {
        if (e.data === "[DONE]") {
          es.close();
          botContent.textContent = fullText;
          input.disabled = false;
          btn.disabled = false;
          input.focus();
        } else {
          try {
            const chunk = JSON.parse(e.data).choices[0].delta.content;
            if (chunk) {
              fullText += chunk;
              botContent.textContent = fullText;
              respBox.scrollTop = respBox.scrollHeight;
            }
          } catch (err) {
            console.warn("JSON 파싱 실패", err);
          }
        }
      };

      es.onerror = err => {
        botContent.textContent = "⚠️ 오류 발생";
        console.error("SSE Error", err);
        es.close();
        input.disabled = false;
        btn.disabled = false;
      };
    }
  </script>
</body>
</html>
