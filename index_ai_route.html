<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>íˆ¬ì–´ë¹„ìŠ¤ ì—ì´ì „íŠ¸ - 1:1 + route</title>
  <script src="https://unpkg.com/event-source-polyfill@1.0.20/eventsource.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      align-items: center;
      overscroll-behavior: none;
    }

    /* ğŸ¯ í—¤ë” ì¶”ê°€ */
    #header {
      width: 100%;
      max-width: 600px;
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      padding: 15px 20px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    #header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    #container {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: calc(100vh - 60px);
      width: 100%;
      max-width: 600px;
      background: white;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    
    #chat {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    
    .msg {
      margin: 10px 0;
      display: flex;
      flex-direction: column;
      opacity: 0;
      animation: slideIn 0.4s ease-out forwards;
    }
    
    .user, .bot {
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 85%;
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.4;
      font-size: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .user {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 6px;
    }
    
    .bot {
      background: white;
      border: 1px solid #e1e5e9;
      align-self: flex-start;
      min-height: 20px;
      transition: all 0.2s ease-out;
      border-bottom-left-radius: 6px;
    }
    
    .bot.typo-processing {
      background: linear-gradient(135deg, #fff3cd, #ffeaa7);
      border-color: #f39c12;
    }
    
    .bot.error {
      background: linear-gradient(135deg, #f8d7da, #f5c6cb);
      border-color: #dc3545;
      color: #721c24;
    }
    
    .timestamp {
      font-size: 11px;
      color: #6c757d;
      margin-top: 4px;
      align-self: flex-end;
    }
    
    .user + .timestamp {
      align-self: flex-end;
    }
    
    .bot + .timestamp {
      align-self: flex-start;
    }
    
    #inputBox {
      display: flex;
      padding: 15px;
      border-top: 1px solid #e1e5e9;
      background: white;
      gap: 10px;
      align-items: flex-end;
      position: sticky;
      bottom: 0;
    }
    
    #q {
      flex: 1;
      font-size: 16px;
      padding: 12px 16px;
      border: 1px solid #ccc;
      border-radius: 25px;
      outline: none;
      resize: none;
      min-height: 44px;
      max-height: 100px;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    
    #q:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    
    #sendBtn {
      width: 44px;
      height: 44px;
      border: none;
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s;
      flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      pointer-events: auto;
      position: relative;
      z-index: 10;
    }
    
    #sendBtn:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,123,255,0.3);
    }
    
    #sendBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    #sendBtn:not(:disabled):active {
      transform: scale(0.95);
    }
    
    a {
      color: #007bff;
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: border-color 0.2s;
    }
    
    a:hover {
      border-bottom-color: #007bff;
    }
    
    @keyframes slideIn {
      from { 
        opacity: 0; 
        transform: translateY(10px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
    
    .typing-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    
    .typing-indicator span {
      width: 6px;
      height: 6px;
      background: #007bff;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }
    
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typing {
      0%, 60%, 100% {
        opacity: 0.3;
        transform: scale(0.8);
      }
      30% {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .typo-notice {
      background: linear-gradient(135deg, #e7f3ff, #cce7ff);
      border: 1px solid #007bff;
      padding: 10px 14px;
      border-radius: 12px;
      margin: 8px 0;
      font-size: 14px;
      color: #0056b3;
      box-shadow: 0 1px 3px rgba(0,123,255,0.1);
    }

    /* ğŸ¯ ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 768px) {
      body {
        font-size: 16px; /* iOS í™•ëŒ€ ë°©ì§€ */
      }

      #header {
        padding: 12px 15px;
      }

      #header h1 {
        font-size: 16px;
      }

      #container {
        height: calc(100vh - 50px);
        max-width: 100%;
        box-shadow: none;
      }
      
      #chat {
        padding: 10px;
      }
      
      .msg {
        margin: 8px 0;
      }
      
      .user, .bot {
        max-width: 90%;
        padding: 10px 14px;
        font-size: 14px;
        border-radius: 16px;
      }

      .user {
        border-bottom-right-radius: 4px;
      }

      .bot {
        border-bottom-left-radius: 4px;
      }
      
      .timestamp {
        font-size: 10px;
        margin-top: 3px;
      }
      
      #inputBox {
        padding: 10px;
        gap: 8px;
      }
      
      #q {
        font-size: 16px; /* iOS í™•ëŒ€ ë°©ì§€ */
        padding: 10px 14px;
        border-radius: 20px;
        min-height: 40px;
        max-height: 80px;
      }
      
      #sendBtn {
        width: 40px;
        height: 40px;
        font-size: 16px;
        min-width: 40px;
        min-height: 40px;
        -webkit-tap-highlight-color: rgba(0,123,255,0.3);
      }

      .typo-notice {
        font-size: 13px;
        padding: 8px 12px;
        margin: 6px 0;
      }

      /* ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
      #chat::-webkit-scrollbar {
        display: none;
      }

      #chat {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    }

    /* ğŸ¯ íƒœë¸”ë¦¿ ìµœì í™” */
    @media (min-width: 769px) and (max-width: 1024px) {
      #container {
        max-width: 700px;
      }
      
      .user, .bot {
        max-width: 80%;
        font-size: 15px;
      }
    }

    /* ğŸ¯ ë°ìŠ¤í¬í†± ìµœì í™” */
    @media (min-width: 1025px) {
      #container {
        max-width: 600px;
      }
      
      .user, .bot {
        max-width: 75%;
      }

      #sendBtn:hover:not(:disabled) {
        background: linear-gradient(135deg, #0056b3, #004494);
      }
    }

    /* ğŸ¯ ë‹¤í¬ëª¨ë“œ ì§€ì› */
    @media (prefers-color-scheme: dark) {
      body {
        background: #1a1a1a;
        color: #ffffff;
      }

      #header {
        background: linear-gradient(135deg, #0056b3, #004494);
      }

      #container {
        background: #2d2d2d;
        box-shadow: 0 0 20px rgba(255,255,255,0.1);
      }

      #chat {
        background: #2d2d2d;
      }

      .bot {
        background: #3a3a3a;
        border-color: #4a4a4a;
        color: #ffffff;
      }

      #inputBox {
        background: #2d2d2d;
        border-top-color: #4a4a4a;
      }

      #q {
        background: #3a3a3a;
        border-color: #4a4a4a;
        color: #ffffff;
      }

      #q::placeholder {
        color: #aaa;
      }

      .timestamp {
        color: #aaa;
      }
    }

    /* ğŸ¯ ì ‘ê·¼ì„± ê°œì„  */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01s !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01s !important;
      }
    }
  </style>
</head>
  <body>
  <div id="header">
    <h1>ğŸ¯ íˆ¬ì–´ë¹„ìŠ¤ ê³ ê°ì„¼í„°  - 1:1 + route</h1>
  </div>
  
  <div id="container">
    <div id="chat"></div>
    <div id="inputBox">
      <textarea id="q" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="1"></textarea>
      <button id="sendBtn" type="button" aria-label="ë©”ì‹œì§€ ì „ì†¡">
        <span id="sendIcon">â¤</span>
      </button>
    </div>
  </div>

<script>
    // ğŸ¯ API ì—”ë“œí¬ì¸íŠ¸ êµ¬ì„± - ìˆ˜ì •ëœ ë²„ì „
    // í¬íŠ¸ ë²ˆí˜¸ ì œê±°í•˜ê³  ì—¬ëŸ¬ URL ì‹œë„í•˜ë„ë¡ ë³€ê²½
    const API_URLS = [
      "https://tourvis-ai-dxojr.run.goorm.site",     // ê¸°ë³¸ HTTPS (í¬íŠ¸ ì œê±°)
      "https://tourvis-ai-dxojr.run.goorm.site:443", // í‘œì¤€ HTTPS í¬íŠ¸
      "http://tourvis-ai-dxojr.run.goorm.site",      // HTTP ëŒ€ì²´
      "http://tourvis-ai-dxojr.run.goorm.site:8080"  // ì›ë˜ URL
    ];

    let API_BASE_URL = API_URLS[0]; // ê¸°ë³¸ê°’

    const CHAT_ENDPOINT = "/api/chat"; 
    const FEEDBACK_ENDPOINT = "/api/feedback/simple"; 
    
    // ë ˆê±°ì‹œ ì—”ë“œí¬ì¸íŠ¸ (ëŒ€ì²´ìš©)
    const LEGACY_CHAT_ENDPOINT = "/chat";
    const LEGACY_FEEDBACK_ENDPOINT = "/feedback-simple";
    
    // í˜„ì¬ ì‚¬ìš©í•  ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •
    let CURRENT_CHAT_ENDPOINT = CHAT_ENDPOINT;
    let CURRENT_FEEDBACK_ENDPOINT = FEEDBACK_ENDPOINT;

    const chat = document.getElementById("chat");
    const input = document.getElementById("q");
    const sendBtn = document.getElementById("sendBtn");
    const sendIcon = document.getElementById("sendIcon");
    let currentBotContent = null;
    let currentChatId = null; // í˜„ì¬ ì±„íŒ… ID
    let currentQAId = null;   // í˜„ì¬ QA ID (í”¼ë“œë°±ìš©)
    let serverReachable = false; // ì„œë²„ ì—°ê²° ìƒíƒœ
    
    // QA ì„¸ì…˜ ê´€ë¦¬
    let qaSession = {
      chatId: null,          // ì±„íŒ… ID
      timestamp: null,       // íƒ€ì„ìŠ¤íƒ¬í”„
      question: null,        // ì§ˆë¬¸ ë‚´ìš©
      questionHash: null     // ì§ˆë¬¸ í•´ì‹œ
    };

    // ğŸ¯ ëª¨ë°”ì¼/PC ê°ì§€
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                     window.innerWidth <= 768;

    // ì„œë²„ ìƒíƒœ í™•ì¸ í•¨ìˆ˜ - ê°œì„ ëœ ë²„ì „
    async function checkServerStatus() {
      console.log("ğŸ” ì„œë²„ ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘...");
      
      // ì—¬ëŸ¬ URLì„ ìˆœì°¨ì ìœ¼ë¡œ ì‹œë„
      for (const baseUrl of API_URLS) {
        try {
          console.log(`ğŸ” ì‹œë„ ì¤‘: ${baseUrl}`);
          
          // ì§§ì€ íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ë¹ ë¥¸ í™•ì¸
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ì´ˆ íƒ€ì„ì•„ì›ƒ
          
          // í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ë“¤ ì‹œë„
          const healthEndpoints = ["/api/admin/health", "/health", "/"];
          
          for (const endpoint of healthEndpoints) {
            try {
              const response = await fetch(`${baseUrl}${endpoint}`, {
                method: 'GET',
                signal: controller.signal,
                headers: {
                  'Accept': 'application/json, text/plain, */*',
                  'Cache-Control': 'no-cache'
                }
              });
              
              clearTimeout(timeoutId);
              
              if (response.ok) {
                console.log(`âœ… ì„œë²„ ì—°ê²° ì„±ê³µ: ${baseUrl}${endpoint}`);
                API_BASE_URL = baseUrl;
                serverReachable = true;
                return true;
              }
            } catch (endpointError) {
              console.log(`âŒ ${baseUrl}${endpoint} ì‹¤íŒ¨:`, endpointError.message);
              continue;
            }
          }
          
          clearTimeout(timeoutId);
          
        } catch (error) {
          console.log(`âŒ ${baseUrl} ì—°ê²° ì‹¤íŒ¨:`, error.message);
          continue;
        }
      }
      
      console.error("âŒ ëª¨ë“  ì„œë²„ URL ì—°ê²° ì‹¤íŒ¨");
      serverReachable = false;
      return false;
    }

    // ì´ˆê¸°í™” ì‹œ ì±„íŒ… ID ê°€ì ¸ì˜¤ê¸° - ê°œì„ ëœ ë²„ì „
    async function initChatId() {
      if (!serverReachable) {
        const connected = await checkServerStatus();
        if (!connected) {
          console.error("ì„œë²„ ì—°ê²° ì‹¤íŒ¨ - ê¸°ë³¸ Chat ID ì‚¬ìš©");
          currentChatId = `user_${Date.now()}`;
          qaSession.chatId = currentChatId;
          return;
        }
      }
      
      const idEndpoints = ["/api/chat/generate-id", "/generate-chat-id"];
      
      for (const endpoint of idEndpoints) {
        try {
          console.log(`ğŸ†” Chat ID ìƒì„± ì‹œë„: ${API_BASE_URL}${endpoint}`);
          
          const response = await fetch(`${API_BASE_URL}${endpoint}`, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Cache-Control': 'no-cache'
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            currentChatId = data.chat_id;
            qaSession.chatId = data.chat_id;
            console.log("ğŸ†” Chat ID ìƒì„± ì„±ê³µ:", currentChatId);
            return;
          }
        } catch (error) {
          console.error(`Chat ID ìƒì„± ì‹¤íŒ¨ (${endpoint}):`, error);
          continue;
        }
      }
      
      // ëª¨ë“  ë°©ë²• ì‹¤íŒ¨ ì‹œ ê³ ìœ  ID ìƒì„±
      currentChatId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      qaSession.chatId = currentChatId;
      console.log("ğŸ†” ë¡œì»¬ Chat ID ìƒì„±:", currentChatId);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” - ê°œì„ ëœ ë²„ì „
    window.addEventListener('load', async () => {
      console.log("ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì‹œì‘");
      
      // ë¡œë”© ìƒíƒœ í‘œì‹œ
      const loadingMsg = document.createElement('div');
      loadingMsg.id = 'loading-status';
      loadingMsg.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        text-align: center; z-index: 9999;
      `;
      loadingMsg.innerHTML = 'ğŸ”„ ì„œë²„ ì—°ê²° ì¤‘...';
      document.body.appendChild(loadingMsg);
      
      const isConnected = await checkServerStatus();
      
      if (!isConnected) {
        // ì„œë²„ ì—°ê²° ì‹¤íŒ¨ ì‹œ ì˜¤í”„ë¼ì¸ ëª¨ë“œ ì•ˆë‚´
        loadingMsg.innerHTML = `
          <div style="color: #dc3545;">
            <h3>âš ï¸ ì„œë²„ ì—°ê²° ë¶ˆê°€</h3>
            <p>ë‹¤ìŒì„ í™•ì¸í•´ì£¼ì„¸ìš”:</p>
            <ul style="text-align: left; margin: 10px 0;">
              <li>ì¸í„°ë„· ì—°ê²° ìƒíƒœ</li>
              <li>ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸</li>
              <li>ë°©í™”ë²½ ì„¤ì •</li>
            </ul>
            <button onclick="location.reload()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
              ë‹¤ì‹œ ì‹œë„
            </button>
          </div>
        `;
        return;
      } else {
        // ì—°ê²° ì„±ê³µ ì‹œ Chat ID ì´ˆê¸°í™”
        await initChatId();
        loadingMsg.remove();
        
        // ì„±ê³µ ë©”ì‹œì§€ ì ê¹ í‘œì‹œ
        const successMsg = document.createElement('div');
        successMsg.style.cssText = `
          position: fixed; top: 20px; right: 20px; background: #28a745; color: white;
          padding: 10px 15px; border-radius: 5px; z-index: 9999;
        `;
        successMsg.textContent = 'âœ… ì„œë²„ ì—°ê²° ì„±ê³µ';
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
      }
    });

    // í•´ì‹œ ê³„ì‚° í•¨ìˆ˜ (QA ID ìƒì„±ìš©)
    function simpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0; // 32ë¹„íŠ¸ ì •ìˆ˜ë¡œ ë³€í™˜
      }
      return Math.abs(hash % 10000); // 0-9999 ì‚¬ì´ ê°’
    }
    
    // QA ID ìƒì„± í•¨ìˆ˜
    function generateQAId(chatId, timestamp, question) {
      const hash = simpleHash(question);
      return `${chatId}_${timestamp}_${hash}`;
    }

    // ğŸ¯ textarea ìë™ ë†’ì´ ì¡°ì ˆ
    input.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });

    // ğŸ¯ Enter í‚¤ ì²˜ë¦¬
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        if (!e.shiftKey) {
          e.preventDefault();
          e.stopPropagation();
          handleSend();
        }
      }
    });

    function addMsg(role, text, timestamp) {
      const wrap = document.createElement("div");
      wrap.className = "msg";

      const content = document.createElement("div");
      content.className = role;
      content.innerHTML = convertLinks(text);

      const time = document.createElement("div");
      time.className = "timestamp";
      time.textContent = timestamp || new Date().toLocaleTimeString();

      wrap.appendChild(content);
      wrap.appendChild(time);
      chat.appendChild(wrap);
      
      // ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
      setTimeout(() => {
        chat.scrollTop = chat.scrollHeight;
      }, 50);
    }

    function convertLinks(text) {
      const urlRegex = /(https?:\/\/[^\s)\]]+)/g;
      return text.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener">${url}</a>`);
    }

    function createTypingIndicator() {
      return `<div class="typing-indicator">ë‹µë³€ ìƒì„± ì¤‘ <span></span><span></span><span></span></div>`;
    }

    function createTypoProcessingIndicator() {
      return `<div class="typing-indicator">ğŸ” ì˜¤íƒ€ í™•ì¸ ì¤‘ <span></span><span></span><span></span></div>`;
    }

    function resetUI() {
      input.disabled = false;
      sendBtn.disabled = false;
      sendIcon.textContent = "â¤";
      input.style.height = 'auto';
      currentBotContent = null;
      
      // ëª¨ë°”ì¼ì—ì„œ í¬ì»¤ìŠ¤ ë¬¸ì œ í•´ê²°
      setTimeout(() => {
        if (!isMobile || !document.activeElement || document.activeElement === document.body) {
          input.focus();
        }
      }, 100);
    }

    // ğŸ¯ ì „ì†¡ ë²„íŠ¼ ì´ë²¤íŠ¸ (ëª¨ë“  í”Œë«í¼ ì§€ì›)
    sendBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      handleSend();
    });
    
    sendBtn.addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      handleSend();
    });

    // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ë„ ì¶”ê°€ (PC í˜¸í™˜ì„±)
    sendBtn.addEventListener('mousedown', function(e) {
      e.preventDefault();
    });

    function handleSend() {
      if (!sendBtn.disabled && !input.disabled) {
        if (!serverReachable) {
          // ì„œë²„ ìƒíƒœ ì¬í™•ì¸
          checkServerStatus().then(isReachable => {
            if (isReachable) {
              send();
            } else {
              alert("ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
          });
        } else {
          send();
        }
      }
    }

    // ìŠ¤íŠ¸ë¦¼ ì‘ë‹µ ì²˜ë¦¬ í•¨ìˆ˜ ë¶„ë¦¬
    async function processStreamResponse(response, botContent, botWrap, timestamp) {
      const reader = response.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let fullText = "";
      let isFirstChunk = true;
      let typoNoticeShown = false;

      try {
        while (true) {
          const { done, value } = await reader.read();
          if (done) {
            console.log('âœ… ìŠ¤íŠ¸ë¦¼ ì™„ë£Œ');
            break;
          }

          const chunk = decoder.decode(value, { stream: true });
          const lines = chunk.split("\n").filter(line => line.startsWith("data:"));
          
          for (const line of lines) {
            const jsonStr = line.replace(/^data:\s*/, "").trim();
            if (jsonStr === "[DONE]") {
              console.log('ğŸ ì‘ë‹µ ì™„ë£Œ');
              resetUI();
              return;
            }

            try {
              const parsed = JSON.parse(jsonStr);
              
              // íŠ¹ìˆ˜ ìƒíƒœ ì²˜ë¦¬
              if (parsed.status) {
                switch (parsed.status) {
                  case 'typo_correction':
                    if (!typoNoticeShown) {
                      botContent.className = "bot typo-processing";
                      botContent.innerHTML = createTypoProcessingIndicator();
                      
                      const typoNotice = document.createElement("div");
                      typoNotice.className = "typo-notice";
                      typoNotice.innerHTML = `ğŸ’¡ "<strong>${parsed.original}</strong>" â†’ "<strong>${parsed.corrected}</strong>"ë¡œ ì´í•´í–ˆìŠµë‹ˆë‹¤.`;
                      botWrap.insertBefore(typoNotice, timestamp);
                      typoNoticeShown = true;
                      
                      chat.scrollTop = chat.scrollHeight;
                    }
                    break;
                    
                  case 'timeout':
                    botContent.className = "bot error";
                    botContent.innerHTML = "â° ì²˜ë¦¬ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì§ˆë¬¸ì„ ë” ì •í™•í•˜ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
                    resetUI();
                    return;
                    
                  case 'error':
                    botContent.className = "bot error";
                    botContent.innerHTML = `âš ï¸ ì˜¤ë¥˜ ë°œìƒ: ${parsed.message}`;
                    resetUI();
                    return;
                }
                continue;
              }
              
              // ì¼ë°˜ í…ìŠ¤íŠ¸ ì‘ë‹µ ì²˜ë¦¬
              const delta = parsed?.choices?.[0]?.delta?.content;
              
              if (parsed?.choices?.[0]?.delta?.type === 'html') {
                botContent.innerHTML += delta;
                continue;
              }
              
              if (delta) {
                if (isFirstChunk) {
                  botContent.className = "bot";
                  fullText = "";
                  isFirstChunk = false;
                }
                fullText += delta;
                botContent.innerHTML = convertLinks(fullText);
                
                if (chat.scrollTop + chat.clientHeight >= chat.scrollHeight - 100) {
                  chat.scrollTop = chat.scrollHeight;
                }
              }
            } catch (err) {
              console.warn("ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨:", err, jsonStr);
            }
          }
        }
      } catch (streamError) {
        console.error("ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬ ì˜¤ë¥˜:", streamError);
        throw streamError;
      } finally {
        resetUI();
      }
    }

    // ê°œì„ ëœ ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
    async function send() {
      const message = input.value.trim();
      
      if (!message) {
        return;
      }

      // ì „ì†¡ ë²„íŠ¼ ë¹„í™œì„±í™”
      input.disabled = true;
      sendBtn.disabled = true;
      sendIcon.textContent = "â³";
      
      addMsg("user", message);
      input.value = "";
      input.style.height = 'auto';

      // QA ì„¸ì…˜ ì •ë³´ ì—…ë°ì´íŠ¸
      qaSession.question = message;
      qaSession.timestamp = Math.floor(Date.now() / 1000);
      qaSession.questionHash = simpleHash(message);
      
      currentQAId = generateQAId(currentChatId, qaSession.timestamp, message);
      console.log("ğŸ†” ìƒì„±ëœ QA ID:", currentQAId);

      // ë´‡ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ìƒì„±
      const botWrap = document.createElement("div");
      botWrap.className = "msg";
      const botContent = document.createElement("div");
      botContent.className = "bot";
      botContent.innerHTML = createTypingIndicator();
      currentBotContent = botContent;
      
      const timestamp = document.createElement("div");
      timestamp.className = "timestamp";
      timestamp.textContent = new Date().toLocaleTimeString();
      
      botWrap.appendChild(botContent);
      botWrap.appendChild(timestamp);
      chat.appendChild(botWrap);
      chat.scrollTop = chat.scrollHeight;

      // ì±„íŒ… ì—”ë“œí¬ì¸íŠ¸ë“¤ì„ ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ì‹œë„
      const chatEndpoints = [
        { url: `${API_BASE_URL}${CHAT_ENDPOINT}`, name: "ìƒˆ API" },
        { url: `${API_BASE_URL}${LEGACY_CHAT_ENDPOINT}`, name: "ë ˆê±°ì‹œ API" }
      ];
      
      let lastError = null;
      
      for (const endpoint of chatEndpoints) {
        try {
          console.log(`ğŸ“¤ ${endpoint.name} ì‹œë„:`, endpoint.url);
          
          const controller = new AbortController();
          const timeoutId = setTimeout(() => {
            controller.abort();
            console.log(`â° ${endpoint.name} íƒ€ì„ì•„ì›ƒ`);
          }, 30000); // 30ì´ˆ íƒ€ì„ì•„ì›ƒ
          
          const response = await fetch(endpoint.url, {
            method: "POST",
            headers: { 
              "Content-Type": "application/json",
              "Accept": "text/plain, application/json",
              "Cache-Control": "no-cache"
            },
            body: JSON.stringify({ 
              chat_id: currentChatId, 
              message 
            }),
            signal: controller.signal
          });

          clearTimeout(timeoutId);
          
          console.log(`ğŸ“¥ ${endpoint.name} ì‘ë‹µ:`, response.status, response.statusText);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          // ì„±ê³µí•œ ì—”ë“œí¬ì¸íŠ¸ë¡œ ì—…ë°ì´íŠ¸
          if (endpoint.url.includes('/api/chat')) {
            CURRENT_CHAT_ENDPOINT = CHAT_ENDPOINT;
            CURRENT_FEEDBACK_ENDPOINT = FEEDBACK_ENDPOINT;
          } else {
            CURRENT_CHAT_ENDPOINT = LEGACY_CHAT_ENDPOINT;
            CURRENT_FEEDBACK_ENDPOINT = LEGACY_FEEDBACK_ENDPOINT;
          }

          // Chat ID í—¤ë”ì—ì„œ ê°€ì ¸ì˜¤ê¸°
          const responseChatId = response.headers.get("X-Chat-ID");
          if (responseChatId) {
            currentChatId = responseChatId;
            console.log("ğŸ†” ì„œë²„ì—ì„œ Chat ID ìˆ˜ì‹ :", currentChatId);
          }

          // ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬
          await processStreamResponse(response, botContent, botWrap, timestamp);
          return; // ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë¨
          
        } catch (error) {
          lastError = error;
          console.error(`âŒ ${endpoint.name} ì‹¤íŒ¨:`, error.message);
          
          // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ì¸ ê²½ìš° ë‹¤ìŒ ì—”ë“œí¬ì¸íŠ¸ ì‹œë„
          if (error.name === 'AbortError' || error.message.includes('fetch')) {
            continue;
          }
          
          // ê¸°íƒ€ ì—ëŸ¬ì˜ ê²½ìš° ì¤‘ë‹¨
          break;
        }
      }
      
      // ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ ì‹¤íŒ¨
      console.error("âŒ ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ ì‹¤íŒ¨");
      
      if (currentBotContent) {
        currentBotContent.className = "bot error";
        currentBotContent.innerHTML = `
          <div>âš ï¸ ì—°ê²° ì‹¤íŒ¨</div>
          <div style="font-size: 12px; margin-top: 8px; color: #666;">
            ${lastError ? lastError.message : 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'}
          </div>
          <div style="margin-top: 8px;">
            <button onclick="location.reload()" style="padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
              ìƒˆë¡œê³ ì¹¨
            </button>
          </div>
        `;
      }
      
      // ì„œë²„ ìƒíƒœ ì¬í™•ì¸
      serverReachable = false;
      setTimeout(() => checkServerStatus(), 2000);
      
      resetUI();
    }

    // ğŸ¯ ê°œì„ ëœ í”¼ë“œë°± ì „ì†¡ í•¨ìˆ˜
    window.sendFeedback = async function(qaId, type) {
      const effectiveQAId = qaId || currentQAId;
      
      if (!effectiveQAId) {
        alert('í”¼ë“œë°±ì„ ì „ì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§ˆë¬¸ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      console.log("ğŸ“¤ í”¼ë“œë°± ì „ì†¡:", effectiveQAId, type);
      
      const feedbackEndpoints = [
        { url: `${API_BASE_URL}${FEEDBACK_ENDPOINT}`, name: "ìƒˆ í”¼ë“œë°± API" },
        { url: `${API_BASE_URL}${LEGACY_FEEDBACK_ENDPOINT}`, name: "ë ˆê±°ì‹œ í”¼ë“œë°± API" }
      ];
      
      for (const endpoint of feedbackEndpoints) {
        try {
          console.log(`ğŸ“¤ ${endpoint.name} ì‹œë„:`, endpoint.url);
          
          const response = await fetch(`${endpoint.url}?chat_id=${effectiveQAId}&type=${type}`, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Cache-Control': 'no-cache'
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.status === 'success') {
              alert('í”¼ë“œë°±ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!');
              
              // ì„±ê³µí•œ ì—”ë“œí¬ì¸íŠ¸ë¡œ ì—…ë°ì´íŠ¸
              if (endpoint.url.includes('/api/feedback')) {
                CURRENT_FEEDBACK_ENDPOINT = FEEDBACK_ENDPOINT;
              } else {
                CURRENT_FEEDBACK_ENDPOINT = LEGACY_FEEDBACK_ENDPOINT;
              }
              return;
            }
          }
        } catch (error) {
          console.error(`âŒ ${endpoint.name} ì‹¤íŒ¨:`, error);
          continue;
        }
      }
      
      alert('í”¼ë“œë°± ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    };

    // ğŸ¯ ì—°ê²° ì§„ë‹¨ ë° ë¬¸ì œ í•´ê²° ê°€ì´ë“œ
    window.diagnoseProblem = async function() {
      const results = [];
      
      console.log("ğŸ” ì—°ê²° ì§„ë‹¨ ì‹œì‘...");
      
      // 1. ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸
      try {
        await fetch('https://www.google.com/favicon.ico', { mode: 'no-cors' });
        results.push('âœ… ì¸í„°ë„· ì—°ê²°: ì •ìƒ');
      } catch {
        results.push('âŒ ì¸í„°ë„· ì—°ê²°: ì‹¤íŒ¨');
      }
      
      // 2. ê° ì„œë²„ URL í…ŒìŠ¤íŠ¸
      for (let i = 0; i < API_URLS.length; i++) {
        const url = API_URLS[i];
        try {
          const response = await fetch(`${url}/health`, { 
            method: 'GET',
            signal: AbortSignal.timeout(5000)
          });
          results.push(`âœ… ì„œë²„ ${i+1} (${url}): ${response.status}`);
        } catch (error) {
          results.push(`âŒ ì„œë²„ ${i+1} (${url}): ${error.message}`);
        }
      }
      
      // 3. ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±… í™•ì¸
      const isHttps = location.protocol === 'https:';
      const mixedContent = isHttps && API_BASE_URL.startsWith('http:');
      results.push(`ğŸ”’ HTTPS í˜ì´ì§€: ${isHttps ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}`);
      results.push(`âš ï¸ Mixed Content: ${mixedContent ? 'ë¬¸ì œ ìˆìŒ' : 'ì •ìƒ'}`);
      
      // 4. ê²°ê³¼ í‘œì‹œ
      const diagDiv = document.createElement('div');
      diagDiv.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        max-width: 500px; width: 90%; z-index: 10000; max-height: 70vh; overflow-y: auto;
      `;
      
      diagDiv.innerHTML = `
        <h3>ğŸ” ì—°ê²° ì§„ë‹¨ ê²°ê³¼</h3>
        <div style="font-family: monospace; font-size: 12px; line-height: 1.5;">
          ${results.map(r => `<div>${r}</div>`).join('')}
        </div>
        <hr>
        <h4>ğŸ’¡ í•´ê²° ë°©ë²•</h4>
        <ul style="font-size: 14px; line-height: 1.5;">
          <li><strong>Mixed Content ë¬¸ì œ:</strong> HTTPS ì‚¬ì´íŠ¸ì—ì„œ HTTP ì„œë²„ ì ‘ê·¼ ë¶ˆê°€</li>
          <li><strong>í¬íŠ¸ ì°¨ë‹¨:</strong> ë°©í™”ë²½ì—ì„œ 8080 í¬íŠ¸ í—ˆìš© í•„ìš”</li>
          <li><strong>ì„œë²„ ë¯¸ì‹¤í–‰:</strong> íˆ¬ì–´ë¹„ìŠ¤ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸</li>
          <li><strong>ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:</strong> ì¸í„°ë„· ì—°ê²° ë° DNS ì„¤ì • í™•ì¸</li>
        </ul>
        <div style="text-align: center; margin-top: 15px;">
          <button onclick="this.parentElement.parentElement.remove()" 
                  style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            ë‹«ê¸°
          </button>
          <button onclick="location.reload()" 
                  style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">
            ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
      `;
      
      document.body.appendChild(diagDiv);
    };

    // ğŸ¯ ê°œì„ ëœ ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
    window.testServerConnection = async function() {
      const testDiv = document.createElement('div');
      testDiv.style.cssText = `
        position: fixed; bottom: 60px; right: 10px; background: white; padding: 15px;
        border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); z-index: 1000;
        max-width: 300px; font-size: 12px; border: 1px solid #ddd;
      `;
      testDiv.innerHTML = 'ğŸ”„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
      document.body.appendChild(testDiv);
      
      const results = [];
      
      // ê° URLê³¼ ì—”ë“œí¬ì¸íŠ¸ ì¡°í•© í…ŒìŠ¤íŠ¸
      for (const baseUrl of API_URLS) {
        const endpoints = ['/health', '/api/admin/health', '/generate-chat-id', '/api/chat/generate-id'];
        
        for (const endpoint of endpoints) {
          try {
            const startTime = Date.now();
            const response = await fetch(`${baseUrl}${endpoint}`, {
              method: 'GET',
              signal: AbortSignal.timeout(3000)
            });
            const endTime = Date.now();
            
            results.push({
              url: `${baseUrl}${endpoint}`,
              status: response.status,
              time: endTime - startTime,
              ok: response.ok
            });
          } catch (error) {
            results.push({
              url: `${baseUrl}${endpoint}`,
              error: error.message,
              ok: false
            });
          }
        }
      }
      
      // ê²°ê³¼ í‘œì‹œ
      const successResults = results.filter(r => r.ok);
      const failedResults = results.filter(r => !r.ok);
      
      testDiv.innerHTML = `
        <div><strong>ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ</strong></div>
        <div style="color: green; margin: 5px 0;">âœ… ì„±ê³µ: ${successResults.length}</div>
        <div style="color: red; margin: 5px 0;">âŒ ì‹¤íŒ¨: ${failedResults.length}</div>
        ${successResults.length > 0 ? `
          <div style="margin-top: 10px; font-size: 11px;">
            <strong>ì‚¬ìš© ê°€ëŠ¥í•œ ì—”ë“œí¬ì¸íŠ¸:</strong><br>
            ${successResults.slice(0, 3).map(r => `${r.url} (${r.time}ms)`).join('<br>')}
          </div>
        ` : ''}
        <div style="margin-top: 10px;">
          <button onclick="this.parentElement.remove()" 
                  style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer;">
            ë‹«ê¸°
          </button>
          <button onclick="diagnoseProblem()" 
                  style="padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer; margin-left: 5px;">
            ìƒì„¸ ì§„ë‹¨
          </button>
        </div>
      `;
      
      // 5ì´ˆ í›„ ìë™ ë‹«ê¸°
      setTimeout(() => {
        if (testDiv.parentElement) {
          testDiv.remove();
        }
      }, 5000);
      
      console.log('ì—°ê²° í…ŒìŠ¤íŠ¸ ê²°ê³¼:', results);
    };

    // ğŸ¯ í–¥ìƒëœ ì—ëŸ¬ ë¦¬í¬íŒ…
    window.reportError = function(error, context) {
      const errorReport = {
        timestamp: new Date().toISOString(),
        error: error.message,
        stack: error.stack,
        context: context,
        userAgent: navigator.userAgent,
        url: location.href,
        apiBaseUrl: API_BASE_URL,
        chatId: currentChatId
      };
      
      console.error('ì—ëŸ¬ ë¦¬í¬íŠ¸:', errorReport);
      
      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì—ëŸ¬ ì €ì¥ (ì„ íƒì‚¬í•­)
      try {
        const errors = JSON.parse(localStorage.getItem('tourvis_errors') || '[]');
        errors.push(errorReport);
        if (errors.length > 10) errors.shift(); // ìµœëŒ€ 10ê°œë§Œ ìœ ì§€
        localStorage.setItem('tourvis_errors', JSON.stringify(errors));
      } catch (e) {
        console.warn('ì—ëŸ¬ ì €ì¥ ì‹¤íŒ¨:', e);
      }
    };

    // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬
    window.addEventListener('error', (event) => {
      reportError(event.error || new Error(event.message), 'Global Error Handler');
    });

    window.addEventListener('unhandledrejection', (event) => {
      reportError(new Error(event.reason), 'Unhandled Promise Rejection');
    });

    // ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€
    const testDiv = document.createElement('div');
    testDiv.style.position = 'fixed';
    testDiv.style.bottom = '10px';
    testDiv.style.right = '10px';
    testDiv.style.zIndex = '1000';
    testDiv.innerHTML = `
      <button onclick="testServerConnection()" style="padding: 8px; background: #007bff; color: white; border: none; border-radius: 4px;">
        ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
      </button>
    `;
    document.body.appendChild(testDiv);

    // ğŸ¯ ì´ˆê¸°í™” ë° ë””ë²„ê¹…
    console.log('ğŸ–¥ï¸ í”Œë«í¼ ê°ì§€:', isMobile ? 'Mobile' : 'Desktop');
    console.log('ğŸ¯ ì „ì†¡ ë²„íŠ¼ ìš”ì†Œ:', sendBtn);
    console.log('ğŸ“ ì…ë ¥ í•„ë“œ ìš”ì†Œ:', input);
    console.log('ğŸŒ API ì—”ë“œí¬ì¸íŠ¸:', `${API_BASE_URL}${CURRENT_CHAT_ENDPOINT}`);
    console.log('ğŸ”„ í”¼ë“œë°± ì—”ë“œí¬ì¸íŠ¸:', `${API_BASE_URL}${CURRENT_FEEDBACK_ENDPOINT}`);
    
    setTimeout(() => {
      if (!isMobile) {
        input.focus();
        console.log('ğŸ¯ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ ì„¤ì •');
      }
    }, 500);
    
    // ğŸ¯ ëª¨ë°”ì¼ì—ì„œ í‚¤ë³´ë“œ ì˜¬ë¼ì˜¬ ë•Œ ëŒ€ì‘
    if (isMobile) {
      let keyboardHeight = 0;
      
      window.addEventListener('resize', () => {
        const currentHeight = window.innerHeight;
        if (currentHeight < keyboardHeight - 100) {
          // í‚¤ë³´ë“œê°€ ì˜¬ë¼ì˜¨ ìƒíƒœ
          setTimeout(() => {
            chat.scrollTop = chat.scrollHeight;
          }, 100);
        }
        keyboardHeight = currentHeight;
      });
      
      // í„°ì¹˜ ìŠ¤í¬ë¡¤ ê°œì„ 
      let touchStartY = 0;
      chat.addEventListener('touchstart', (e) => {
        touchStartY = e.touches[0].clientY;
      });
      
      chat.addEventListener('touchmove', (e) => {
        const touchY = e.touches[0].clientY;
        const scrollTop = chat.scrollTop;
        const maxScroll = chat.scrollHeight - chat.clientHeight;
        
        if ((scrollTop <= 0 && touchY > touchStartY) || 
            (scrollTop >= maxScroll && touchY < touchStartY)) {
          e.preventDefault();
        }
      }, { passive: false });
    }

    // ğŸ¯ í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ í¬ì»¤ìŠ¤ ê´€ë¦¬
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && !input.disabled) {
        input.focus();
      }
    });
  </script>
</body>
</html>
